# cp2800.proto
# Stream Device Protocol for the Cryomech CP2800 series compressor
# Pete Owens 6/1/2012

#
# NOTE: Stream device must include SMDP format converter "%!"
#

terminator   = CR;
replytimeout = 1000;
readtimeout  = 1000;

DLY = 20; # delay between commands - may make comms more reliable

ADR = 0x10;
CMD = 0x80;
RSP = 0x89;
#
CP_CMD = STX $ADR $CMD;
CP_RSP = STX $ADR $RSP;

#
# Data Dictionary Enties
# Byte 1:    'a' = write 'c' = read
# Bytes 2-3: hash of dictionary variable
# Byte 4:    index (for arrays)
# Bites 5-8: output value (for write commands only)
#

COMP_ON   = 'c' 0x5F 0x95 0;         # True if compessor is on
ERR_CODE  = 'c' 0x65 0xA4 0;         # 0 = no error
COMP_MIN  = 'c' 0x45 0x4C 0;         # Elapsed compressor minutes


# TEMP_0    = 'c' 0x0D 0x8F 0;         # Input water temperature (0.1 degC)
# TEMP_1    = 'c' 0x0D 0x8F 1;         # Output water temperature (0.1 degC)
# TEMP_2    = 'c' 0x0D 0x8F 2;         # Helium temperature (0.1 degC)
# TEMP_3    = 'c' 0x0D 0x8F 3;         # Oil temperature (0.1 degC)
# H_ALP     = 'c' 0xBB 0x94 0;         # Average low side pressure (0.1 PSIA)
# H_AHP     = 'c' 0x7E 0x90 0;         # Average high side pressure (0.1 PSIA)




#test { out "%s"; in "%40c"; }
test { out "%s%1!"; in "%1!%40c"; }

#
# Extract the CMD_RSP byte on mismatch
#
@mismatch  { in "%1!" STX $ADR "%(\$1CMDRSP.VAL)01r%*30c"; }


prod_id { 
    out STX $ADR 0x30 "%01<sum8>%1!"; 
    in "%*1!" STX $ADR 0x31 "%40c"; 
    wait $DLY;
}

comp_on  { 
    out $CP_CMD $COMP_ON  "%01<sum8>%1!"; 
    in "%1!" $CP_RSP $COMP_ON  "%4r%01<sum8>"; 
    wait $DLY; 
}

err_code { 
    out $CP_CMD $ERR_CODE "%01<sum8>%1!"; 
    in "%1!" $CP_RSP $ERR_CODE "%4r%01<sum8>"; 
    wait $DLY; 
}

comp_min { 
    out $CP_CMD $COMP_MIN "%01<sum8>%1!"; 
    in "%1!" $CP_RSP $COMP_MIN "%4r%01<sum8>"; 
    wait $DLY; 
}


# temp_0   { out $CP_CMD $TEMP_0   "%01<sum8>%1!"; in "%1!" $CP_RSP $TEMP_0   "%4r%01<sum8>"; wait $DLY; }
# temp_1   { out $CP_CMD $TEMP_1   "%01<sum8>%1!"; in "%1!" $CP_RSP $TEMP_1   "%4r%01<sum8>"; wait $DLY; }
# temp_2   { out $CP_CMD $TEMP_2   "%01<sum8>%1!"; in "%1!" $CP_RSP $TEMP_2   "%4r%01<sum8>"; wait $DLY; }
# temp_3   { out $CP_CMD $TEMP_3   "%01<sum8>%1!"; in "%1!" $CP_RSP $TEMP_3   "%4r%01<sum8>"; wait $DLY; }

# h_alp    { out $CP_CMD $H_ALP    "%01<sum8>%1!"; in "%1!" $CP_RSP $H_ALP    "%4r%01<sum8>"; wait $DLY; }
# h_ahp    { out $CP_CMD $H_AHP    "%01<sum8>%1!"; in "%1!" $CP_RSP $H_AHP    "%4r%01<sum8>"; wait $DLY; }


